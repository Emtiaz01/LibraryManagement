@model IEnumerable<LibraryManagementSystem.Models.BookLoan>
@inject AdminXLoginRegistration.Data.ApplicationDbContext db
@{
    Layout = "~/Views/Shared/_AdminPage.cshtml";
    var filter = ViewBag.CurrentFilter as string ?? "latest";
    var options = new List<(string value, string label)>
    {
        ("latest", "Latest first"),
        ("oldest", "Oldest first"),
        ("returned", "Returned books"),
        ("notreturned", "Not returned"),
        ("finepaid", "Fine Paid"),
        ("finenotpaid", "Fine Not Paid")
    };
    bool hasPremium = (ViewBag.HasPremium ?? false);
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />

@if (!Model.Any())
{
    <div class="alert alert-info text-center my-5 fs-5">
        <i class="bi bi-emoji-smile"></i> You have not borrowed any books yet!
    </div>
}
else
{
    <form method="get" asp-action="MyBorrowedBooks" class="mb-3" style="max-width:330px;">
        <label for="filter" class="form-label fw-semibold">Filter by:</label>
        <select name="filter" id="filter" class="form-select" onchange="this.form.submit()" style="display:inline;width:auto;">
            @foreach (var opt in options)
            {
                <option value="@opt.value" selected="@(filter == opt.value ? "selected" : null)">@opt.label</option>
            }
        </select>
    </form>
    <form method="post" asp-action="ClearHistory" style="display:inline;">
        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to clear all history?');">
            <i class="bi bi-trash"></i> Clear History
        </button>
    </form>
    <div class="table-responsive">
        <table class="table table-bordered align-middle bg-white">
            <thead class="table-secondary">
                <tr>
                    <th>Book</th>
                    <th>Author</th>
                    <th>Borrow Date</th>
                    <th>Due Date</th>
                    <th>Return Date</th>
                    <th>Fine Amount</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var loan in Model)
                {
                    int overdueDays = 0;
                    double calculatedFine = 0;
                    bool isOverdue = false;
                    double fineRate = hasPremium ? 25.0 : 50.0; // <-- Correct fine rate based on premium

                    if (loan.ReturnDate == null)
                    {
                        overdueDays = (DateTime.Today - loan.DueDate.Date).Days;
                        if (overdueDays > 0)
                        {
                            calculatedFine = overdueDays * fineRate;
                            isOverdue = true;
                        }
                        else
                        {
                            overdueDays = 0;
                            calculatedFine = 0;
                        }
                    }

                    var paidPayment = db.Payment
                    .Where(p => p.BookLoanId == loan.BookLoanId && p.Status == "Paid")
                    .OrderByDescending(p => p.PaymentDate)
                    .FirstOrDefault();

                    bool paid = paidPayment != null;
                    bool fineDue = (loan.FineAmount > 0 || calculatedFine > 0) && !paid;
                    double displayFineAmount = loan.FineAmount > 0
                    ? loan.FineAmount 
                    : calculatedFine;
                
                    <tr>
                        <td>
                            <div class="d-flex align-items-center" style="gap:12px;">
                                @if (!string.IsNullOrEmpty(loan.Product?.ProductImage))
                                {
                                    <img src="@loan.Product.ProductImage"
                                         alt="@loan.Product.ProductName Cover"
                                         style="height:64px;width:43px;object-fit:cover;border-radius:6px;box-shadow:0 2px 10px -7px #002e6d33;" />
                                }
                                <span class="fw-semibold">@loan.Product?.ProductName</span>
                            </div>
                        </td>
                        <td>@loan.Product?.ProductAuthor</td>
                        <td>@loan.BorrowDate.ToString("dd MMM yyyy")</td>
                        <td>@loan.DueDate.ToString("dd MMM yyyy")</td>
                        <td>
                            @if (loan.ReturnDate != null)
                            {
                                @loan.ReturnDate?.ToString("dd MMM yyyy")
                            }
                            else if (loan.Status != null && loan.Status.ToString().ToLower().Contains("returnpending"))
                            {
                                <span class="text-info">Return Pending</span>
                            }
                            else
                            {
                                <span class="text-warning">Not Returned</span>
                            }
                        </td>
                        <td>
                            @if (fineDue)
                            {
                                <span class="text-danger fw-semibold">
                                    ৳@($"{displayFineAmount:0.##}")
                                    @if (isOverdue && overdueDays > 0)
                                    {
                                        <span class="text-muted ms-1">(Overdue @overdueDays day@(overdueDays > 1 ? "s" : ""))</span>
                                        @if (hasPremium)
                                        {
                                            <span class="badge bg-warning text-dark ms-2">Premium: 50% Fine</span>
                                        }
                                    }
                                </span>
                            }
                            else if (paid)
                            {
                                <span class="badge bg-success">Fine Paid</span>
                            }
                            else
                            {
                                <span class="text-success">No Fine</span>
                            }
                        </td>
                        <td>
                            @loan.Status.ToString()
                        </td>
                        <td>
                            @if (fineDue && isOverdue)
                            {
                                <a asp-area="CustomerArea" asp-controller="Payment" asp-action="FinePayment"
                                   asp-route-bookLoanId="@loan.BookLoanId"
                                   class="btn btn-warning btn-sm mb-1">
                                    <i class="bi bi-cash-coin"></i> Pay Fine
                                </a>
                            }
                            else if (loan.ReturnDate == null && !fineDue && !isOverdue)
                            {
                                <form asp-area="CustomerArea" asp-controller="Customer" asp-action="ReturnBook" method="post" class="d-inline">
                                    <input type="hidden" name="BookLoanId" value="@loan.BookLoanId" />
                                    <button type="submit" class="btn btn-primary btn-sm">
                                        <i class="bi bi-arrow-return-left"></i> Return
                                    </button>
                                </form>
                            }
                            @if (paidPayment != null)
                            {
                                <a asp-area="CustomerArea"
                                   asp-controller="Payment"
                                   asp-action="FinePaymentSuccess"
                                   asp-route-paymentId="@paidPayment.PaymentId"
                                   class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-download"></i> Download Invoice
                                </a>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
